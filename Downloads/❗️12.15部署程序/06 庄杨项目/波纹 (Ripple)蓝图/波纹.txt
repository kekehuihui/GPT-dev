import React, { useState, useEffect, useRef } from 'react';
import { 
  AreaChart, Area, Line, LineChart, ComposedChart, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
  BarChart, Bar, Cell, PieChart, Pie, ReferenceLine, ScatterChart, Scatter, ZAxis
} from 'recharts';
import { 
  Activity, MessageSquare, Zap, Search, Bell, Settings, 
  ArrowUpRight, ArrowDownRight, TrendingUp, TrendingDown, 
  Layers, FileText, ChevronDown, Monitor, Share2, Globe, Target, Sparkles, Loader2, X, 
  Thermometer, BarChart3, PieChart as PieChartIcon, LayoutGrid, Flame, ExternalLink, Clock,
  Calendar, Megaphone, Banknote, AlertTriangle, ArrowRight, Link, Info, Download, Printer, FileCheck,
  Trophy, TrendingUp as TrendingUpIcon, AlertCircle, Eye, Briefcase, ChevronRight, ArrowLeft, Filter,
  Waves, Coffee, Moon, Gavel, BarChart2, User, ThumbsUp, MessageCircle, Network, History,
  Send, Bot, Share, BellRing, Vote, ThumbsDown, Database
} from 'lucide-react';

// ==========================================
// 1. å…¨å±€é…ç½®ä¸æ¨¡æ‹Ÿæ•°æ®
// ==========================================

const STOCKS = [
  { code: '600519', name: 'è´µå·èŒ…å°', price: 1780.50, change: 1.25, marketVal: '2.1T' },
  { code: '300750', name: 'å®å¾·æ—¶ä»£', price: 210.20, change: -0.85, marketVal: '980B' },
  { code: '002594', name: 'æ¯”äºšè¿ª', price: 288.60, change: 2.10, marketVal: '760B' },
  { code: '688981', name: 'ä¸­èŠ¯å›½é™…', price: 54.30, change: 0.45, marketVal: '420B' },
  { code: '601318', name: 'ä¸­å›½å¹³å®‰', price: 42.10, change: -0.30, marketVal: '800B' },
];

const INDICES = [
  { name: 'ä¸Šè¯æŒ‡æ•°', code: '000001', value: 3050.21, change: 0.85, volume: '4500äº¿' },
  { name: 'æ·±è¯æˆæŒ‡', code: '399001', value: 9850.12, change: 1.20, volume: '5800äº¿' },
  { name: 'åˆ›ä¸šæ¿æŒ‡', code: '399006', value: 1890.55, change: -0.45, volume: '2100äº¿' },
  { name: 'ç§‘åˆ›50', code: '000688', value: 860.30, change: 1.55, volume: '890äº¿' },
];

const MARKET_BREADTH = [
  { range: 'è·Œåœ', count: 12, color: '#059669' },
  { range: '-7%~', count: 45, color: '#10b981' },
  { range: '-3%~', count: 320, color: '#34d399' },
  { range: 'å¹³ç›˜', count: 210, color: '#94a3b8' },
  { range: '~3%', count: 2800, color: '#fb7185' },
  { range: '~7%', count: 850, color: '#f43f5e' },
  { range: 'æ¶¨åœ', count: 68, color: '#e11d48' },
];

const SENTIMENT_LEADERBOARD = [
  { rank: 1, code: '603259', name: 'è¯æ˜åº·å¾·', price: 52.10, change: -8.50, heat: 98500, sentiment: -0.85, tag: 'æ³•æ¡ˆåˆ©ç©º', reason: 'ç¾ç”Ÿç‰©å®‰å…¨æ³•æ¡ˆå‘é…µï¼Œææ…Œæƒ…ç»ªè”“å»¶' },
  { rank: 2, code: '601127', name: 'èµ›åŠ›æ–¯', price: 88.90, change: -3.40, heat: 92100, sentiment: -0.45, tag: 'è·åˆ©å…‘ç°', reason: 'é—®ç•Œé”€é‡è™½ç„¶æ–°é«˜ï¼Œä½†çŸ­æœŸæ¶¨å¹…è¿‡å¤§' },
  { rank: 3, code: '002230', name: 'ç§‘å¤§è®¯é£', price: 45.60, change: 5.20, heat: 88400, sentiment: 0.78, tag: 'å¤§æ¨¡å‹è½åœ°', reason: 'æ˜Ÿç«å¤§æ¨¡å‹ V4.0 å‘å¸ƒï¼ŒBç«¯è®¢å•è¶…é¢„æœŸ' },
  { rank: 4, code: '300750', name: 'å®å¾·æ—¶ä»£', price: 210.20, change: -0.85, heat: 76200, sentiment: 0.65, tag: 'ä¸šç»©é¢„å–œ', reason: 'Q3 è´¢æŠ¥å‰ç»æ˜¾ç¤ºåˆ©æ¶¦ç‡ä¿®å¤' },
  { rank: 5, code: '002594', name: 'æ¯”äºšè¿ª', price: 288.60, change: 2.10, heat: 65000, sentiment: 0.55, tag: 'å‡ºå£æ•°æ®', reason: '9æœˆæµ·å¤–å‡ºå£æ•°æ®åŒæ¯”ç¿»å€' },
];

const SECTORS_ALL = [
  { name: 'ä½ç©ºç»æµ', change: 4.5, hot: 98, limitUp: 12, total: 45, netInflow: '+15.2äº¿', turnover: '15.2%', volRatio: 2.5, leadStock: 'ä¸‡ä¸°å¥¥å¨' },
  { name: 'åŠå¯¼ä½“', change: 3.2, hot: 85, limitUp: 8, total: 120, netInflow: '+8.5äº¿', turnover: '8.5%', volRatio: 1.8, leadStock: 'ä¸­èŠ¯å›½é™…' },
  { name: 'AIåº”ç”¨', change: 2.8, hot: 82, limitUp: 5, total: 68, netInflow: '+3.2äº¿', turnover: '12.1%', volRatio: 2.1, leadStock: 'ç§‘å¤§è®¯é£' },
  { name: 'CPOæ¦‚å¿µ', change: 2.1, hot: 75, limitUp: 3, total: 35, netInflow: '+1.5äº¿', turnover: '9.8%', volRatio: 1.5, leadStock: 'ä¸­é™…æ—­åˆ›' },
  { name: 'æ¶ˆè´¹ç”µå­', change: 1.8, hot: 68, limitUp: 2, total: 95, netInflow: '-2.1äº¿', turnover: '6.5%', volRatio: 1.2, leadStock: 'ç«‹è®¯ç²¾å¯†' },
  { name: 'ç™½é…’', change: 0.5, hot: 45, limitUp: 1, total: 20, netInflow: '+2.1äº¿', turnover: '2.1%', volRatio: 0.8, leadStock: 'è´µå·èŒ…å°' },
  { name: 'é“¶è¡Œ', change: -0.2, hot: 35, limitUp: 0, total: 42, netInflow: '-1.2äº¿', turnover: '0.8%', volRatio: 0.6, leadStock: 'æ‹›å•†é“¶è¡Œ' },
  { name: 'åŒ»è¯ç”Ÿç‰©', change: -0.8, hot: 32, limitUp: 0, total: 210, netInflow: '-8.5äº¿', turnover: '3.2%', volRatio: 0.7, leadStock: 'æ’ç‘åŒ»è¯' },
  { name: 'æˆ¿åœ°äº§', change: -1.5, hot: 40, limitUp: 0, total: 85, netInflow: '-5.6äº¿', turnover: '4.5%', volRatio: 0.9, leadStock: 'ä¸‡ç§‘A' },
  { name: 'å…‰ä¼è®¾å¤‡', change: -2.1, hot: 28, limitUp: 0, total: 65, netInflow: '-12.1äº¿', turnover: '5.6%', volRatio: 1.1, leadStock: 'éš†åŸºç»¿èƒ½' },
];
const SECTORS_BRIEF = SECTORS_ALL.slice(0, 5);

const UPCOMING_EVENTS_ALL = [
  { id: 1, date: '10-24', daysLeft: 2, title: 'å…¨çƒä½ç©ºç»æµäº§ä¸šå³°ä¼š', target: 'ä½ç©ºç»æµ', type: 'sector', mediaHeat: 92, fundFlow: '-12.5äº¿', priceChange: '+15.2%', prediction: 'risk', summary: 'å£°é‡è¿‡çƒ­ï¼Œè­¦æƒ•åˆ©å¥½å…‘ç°', description: 'å…¨çƒé¡¶çº§çš„ä½ç©ºç»æµäº§ä¸šå³°ä¼šã€‚', aiAnalysis: '...' },
  { id: 2, date: '10-26', daysLeft: 4, title: 'åä¸ºå…¨åœºæ™¯æ–°å“å‘å¸ƒä¼š', target: 'æ¶ˆè´¹ç”µå­', type: 'sector', mediaHeat: 65, fundFlow: '+5.2äº¿', priceChange: '+2.1%', prediction: 'opportunity', summary: 'å£°é‡çˆ¬å¡æœŸï¼Œèµ„é‡‘æŠ¢ç­¹æ˜æ˜¾', description: 'åä¸ºå³å°†å‘å¸ƒ Mate 70 ç³»åˆ—ã€‚', aiAnalysis: '...' },
  { id: 3, date: '10-30', daysLeft: 8, title: 'Q3 è´¢æŠ¥æŠ«éœ²æˆªæ­¢æ—¥', target: 'æ–°èƒ½æº', type: 'sector', mediaHeat: 45, fundFlow: '+1.8äº¿', priceChange: '-0.5%', prediction: 'opportunity', summary: 'èˆ†æƒ…ä½ä½ï¼Œä¸šç»©é¢„æœŸå·®åšå¼ˆ', description: 'Aè‚¡ä¸Šå¸‚å…¬å¸ä¸‰å­£æŠ¥æŠ«éœ²æœ€åæœŸé™ã€‚', aiAnalysis: '...' },
  { id: 4, date: '11-05', daysLeft: 14, title: 'ç¾å›½å¤§é€‰æŠ•ç¥¨æ—¥', target: 'è´µé‡‘å±', type: 'sector', mediaHeat: 88, fundFlow: '+22äº¿', priceChange: '+5.6%', prediction: 'neutral', summary: 'å®è§‚åˆ†æ­§å¤§ï¼Œé¿é™©æƒ…ç»ªå‡æ¸©', description: 'ç¾å›½æ€»ç»Ÿå¤§é€‰æŠ•ç¥¨æ—¥ã€‚', aiAnalysis: '...' },
];
const UPCOMING_EVENTS_BRIEF = UPCOMING_EVENTS_ALL.slice(0, 4);

const STOCK_NEWS_ALL = [
  { id: 1, title: 'é‡ç£…ï¼å…¬å¸æ‹Ÿæ–¥èµ„ 30 äº¿- 60 äº¿å…ƒå›è´­è‚¡ä»½ï¼Œæ³¨é”€å¼å›è´­ææŒ¯ä¿¡å¿ƒ', source: 'è¯åˆ¸æ—¶æŠ¥', time: '15åˆ†é’Ÿå‰', heat: 98520, sentiment: 'pos', url: '#' },
  { id: 2, title: 'å¤–èµ„åŠ ä»“åå•æ›å…‰ï¼šåŒ—å‘èµ„é‡‘è¿ç»­5æ—¥å‡€ä¹°å…¥ï¼Œé‡ç‚¹é”å®šè¯¥é¾™å¤´', source: 'ä¸œæ–¹è´¢å¯Œç½‘', time: '32åˆ†é’Ÿå‰', heat: 87400, sentiment: 'pos', url: '#' },
  { id: 3, title: 'è¡Œä¸šæ·±åº¦ï¼šä»·æ ¼æˆ˜ä½•æ—¶ä¼‘ï¼Ÿäº§ä¸šé“¾ä¸Šä¸‹æ¸¸åšå¼ˆåŠ å‰§ï¼Œæ¯›åˆ©æ‰¿å‹', source: 'è´¢è”ç¤¾', time: '1å°æ—¶å‰', heat: 65200, sentiment: 'neg', url: '#' },
  { id: 4, title: 'åˆ†æå¸ˆä¼šè®®çºªè¦ï¼šQ3 ä¸šç»©æŒ‡å¼•è¶…é¢„æœŸï¼ŒAI ä¸šåŠ¡æˆæ–°å¢é•¿æ', source: 'é›ªçƒä¸“æ ', time: '2å°æ—¶å‰', heat: 54100, sentiment: 'pos', url: '#' },
  { id: 5, title: 'æŠ€æœ¯é¢çªå‘ï¼šæ”¾é‡çªç ´åŠå¹´çº¿ï¼ŒMACDé‡‘å‰ï¼Œåå¼¹ç©ºé—´æ‰“å¼€ï¼Ÿ', source: 'æ–°æµªè´¢ç»', time: '4å°æ—¶å‰', heat: 32000, sentiment: 'neu', url: '#' },
];
const STOCK_NEWS_BRIEF = STOCK_NEWS_ALL.slice(0, 3);

const KEYWORDS = [
  { text: 'ä¸šç»©è¶…é¢„æœŸ', weight: 85, type: 'pos' },
  { text: 'ä¸»åŠ›å¸ç­¹', weight: 72, type: 'pos' },
  { text: 'é‡ä»·é½å‡', weight: 65, type: 'pos' },
  { text: 'ä¸Šæ–¹å‹åŠ›', weight: 45, type: 'neg' },
  { text: 'ç¼©é‡å›è°ƒ', weight: 30, type: 'neu' },
];

const BACKTEST_DATA = Array.from({length: 30}, (_, i) => ({
  day: i + 1,
  strategy: 1000 * (1 + Math.sin(i * 0.2) * 0.15 + i * 0.02),
  benchmark: 1000 * (1 + Math.sin(i * 0.2) * 0.05 + i * 0.005),
}));

// åˆå§‹åŒ–æ¨¡æ‹Ÿæ—¶é—´
const INITIAL_MOCK_TIME = new Date();
INITIAL_MOCK_TIME.setHours(11, 28, 0, 0);

const getMarketStatus = (date) => {
  const h = date.getHours();
  const m = date.getMinutes();
  const totalMinutes = h * 60 + m;
  if (totalMinutes >= 9 * 60 + 15 && totalMinutes < 9 * 60 + 30) return { status: 'auction', label: 'é›†åˆç«ä»·', color: 'bg-violet-500', icon: Gavel, message: 'æ’®åˆåŒ¹é…ä¸­...' };
  if (totalMinutes >= 9 * 60 + 30 && totalMinutes < 11 * 60 + 30) return { status: 'trading', label: 'è¿ç»­ç«ä»·', color: 'bg-emerald-500', icon: Activity, message: 'äº¤æ˜“è¿›è¡Œä¸­' };
  if (totalMinutes >= 11 * 60 + 30 && totalMinutes < 13 * 60) return { status: 'break', label: 'åˆé—´ä¼‘å¸‚', color: 'bg-orange-400', icon: Coffee, message: 'å¸‚åœºä¼‘æ¯ä¸­' };
  if (totalMinutes >= 13 * 60 && totalMinutes < 15 * 60) return { status: 'trading', label: 'è¿ç»­ç«ä»·', color: 'bg-emerald-500', icon: Activity, message: 'åˆåå¼€ç›˜' };
  return { status: 'closed', label: 'å·²é—­å¸‚', color: 'bg-slate-500', icon: Moon, message: 'å¤ç›˜æ—¶é—´' };
};

const generateChartData = () => {
  return Array.from({ length: 60 }, (_, i) => {
    const basePrice = 100;
    const trend = Math.sin(i * 0.1) * 10;
    const noise = (Math.random() - 0.5) * 5;
    const sentimentBase = Math.sin((i + 5) * 0.1); 
    const smartMoney = sentimentBase + (Math.random() - 0.5) * 0.3;
    const dumbMoney = sentimentBase - (Math.random() - 0.5) * 0.8; 
    
    return {
      time: `10:${i < 10 ? '0' + i : i}`,
      price: parseFloat((basePrice + trend + noise).toFixed(2)),
      sentiment: parseFloat((sentimentBase + (Math.random() - 0.5) * 0.5).toFixed(2)),
      smartMoney: parseFloat(smartMoney.toFixed(2)),
      dumbMoney: parseFloat(dumbMoney.toFixed(2)),
      volume: Math.floor(Math.random() * 2000) + 1000
    };
  });
};

// ==========================================
// 3. å­ç»„ä»¶å®šä¹‰ (åœ¨ä¸»ç»„ä»¶ä¹‹å‰)
// ==========================================

const GaugeChart = ({ value }) => {
  const normalizedValue = Math.min(Math.max(value, 0), 100);
  const colors = ['#047857', '#34d399', '#cbd5e1', '#fbbf24', '#f43f5e'];
  const labels = ['æåº¦å†°ç‚¹', 'æƒ…ç»ªä½è¿·', 'å¤šç©ºå¹³è¡¡', 'æƒ…ç»ªå‡æ¸©', 'æåº¦äº¢å¥‹'];
  const zoneIndex = Math.min(Math.floor(normalizedValue / 20), 4);
  const currentLabel = labels[zoneIndex];
  const currentColor = colors[zoneIndex];
  const angle = (normalizedValue / 100) * 180 - 90;
  
  const ticks = Array.from({length: 11}, (_, i) => {
    const tickAngle = (i * 18) - 90;
    const isMajor = i % 2 === 0;
    const labelVal = i * 10;
    const rad = (tickAngle - 90) * (Math.PI / 180);
    const textR = 60; 
    
    return (
      <g key={i} transform={`rotate(${tickAngle} 100 100)`}>
         <line x1="100" y1="20" x2="100" y2={isMajor ? 28 : 25} stroke={isMajor ? "#334155" : "#cbd5e1"} strokeWidth={isMajor ? 2 : 1} />
         {isMajor && <text x="100" y="38" transform={`rotate(${-tickAngle} 100 38)`} textAnchor="middle" fontSize="8" fill="#94a3b8" fontWeight="bold">{labelVal}</text>}
      </g>
    );
  });

  return (
    <div className="flex flex-col items-center justify-center w-full h-full pt-2">
       <div className="relative w-[240px] h-[120px] overflow-hidden">
          <svg viewBox="0 0 200 100" className="w-full h-full overflow-visible">
             <defs><linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor="#047857" /><stop offset="25%" stopColor="#34d399" /><stop offset="50%" stopColor="#cbd5e1" /><stop offset="75%" stopColor="#fbbf24" /><stop offset="100%" stopColor="#f43f5e" /></linearGradient><filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="2" stdDeviation="2" floodOpacity="0.1" /></filter></defs>
             <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#f1f5f9" strokeWidth={14} strokeLinecap="round" />
             <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="url(#gaugeGradient)" strokeWidth={14} strokeLinecap="round" strokeDasharray={`${(normalizedValue / 100) * 251} 251`} className="transition-all duration-1000 ease-out" />
             {ticks}
             <g transform={`rotate(${angle} 100 100)`} className="transition-transform duration-700 ease-out origin-[100px_100px]"><path d="M 98 100 L 100 25 L 102 100 Z" fill="#1e293b" /><circle cx="100" cy="100" r="5" fill="#1e293b" /><circle cx="100" cy="100" r="2" fill="white" /></g>
          </svg>
          <div className="absolute bottom-0 left-0 text-[10px] font-bold text-emerald-600/80">ææ…Œ</div>
          <div className="absolute bottom-0 right-0 text-[10px] font-bold text-rose-600/80">è´ªå©ª</div>
       </div>
       <div className="text-center mt-2 z-10">
          <div className="text-3xl font-extrabold text-slate-900 font-feature-settings-tnum tracking-tight">{value}</div>
          <div className="text-xs font-bold mt-1 px-3 py-1 rounded-full inline-block border transition-colors duration-300" style={{ backgroundColor: `${currentColor}15`, color: currentColor === '#cbd5e1' ? '#64748b' : currentColor, borderColor: `${currentColor}30` }}>{currentLabel}</div>
       </div>
    </div>
  );
};

const EnhancedMetricCard = ({ title, value, subValue, trend, icon: Icon, colorClass, bgClass, type = 'normal' }) => (
  <div className="bg-white border border-gray-100/80 rounded-2xl p-6 shadow-sm hover:shadow-lg hover:shadow-gray-100/50 transition-all duration-300 group flex flex-col justify-between h-full relative overflow-hidden">
    <div className="flex justify-between items-start mb-2">
       <div className={`p-3 rounded-xl ${bgClass} group-hover:scale-110 transition-transform duration-300`}><Icon size={20} className={colorClass} /></div>
       {type === 'heat' && <div className="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-bold animate-pulse">HOT</div>}
    </div>
    <div className="mt-2">
      <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">{title}</p>
      <div className="flex items-baseline gap-2">
         <h3 className="text-2xl font-bold text-gray-900 tracking-tight font-feature-settings-tnum">{value}</h3>
         <div className={`flex items-center gap-0.5 text-xs font-medium ${trend === 'up' ? 'text-rose-600' : trend === 'down' ? 'text-emerald-600' : 'text-gray-500'}`}>{trend === 'up' ? <TrendingUp size={12} /> : <TrendingDown size={12} />}{subValue}</div>
      </div>
      {type === 'heat' && (<div className="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden mt-3"><div className="h-full bg-gradient-to-r from-orange-300 to-rose-500" style={{width: '85%'}}></div></div>)}
      {type === 'divergence' && (<div className="flex gap-1 h-1.5 mt-3"><div className="bg-rose-400 rounded-l-full" style={{width: '70%'}}></div><div className="bg-emerald-400 rounded-r-full" style={{width: '30%'}}></div></div>)}
    </div>
  </div>
);

const RippleGraph = () => (
    <div className="relative w-full h-[500px] bg-slate-900 rounded-2xl overflow-hidden shadow-inner flex items-center justify-center">
       <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div>
       <svg className="absolute inset-0 w-full h-full pointer-events-none"><line x1="50%" y1="50%" x2="70%" y2="30%" stroke="#475569" strokeWidth="2" strokeDasharray="5,5" /><line x1="50%" y1="50%" x2="70%" y2="70%" stroke="#475569" strokeWidth="2" strokeDasharray="5,5" /><line x1="70%" y1="30%" x2="85%" y2="20%" stroke="#334155" strokeWidth="1" /><line x1="70%" y1="30%" x2="85%" y2="40%" stroke="#334155" strokeWidth="1" /><line x1="70%" y1="70%" x2="85%" y2="60%" stroke="#334155" strokeWidth="1" /><line x1="70%" y1="70%" x2="85%" y2="80%" stroke="#334155" strokeWidth="1" /></svg>
       <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 flex flex-col items-center animate-pulse"><div className="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.6)] border-4 border-indigo-400/30"><div className="text-center text-white"><div className="text-xs font-bold opacity-80">æ ¸å¿ƒäº‹ä»¶</div><div className="text-sm font-bold">ç®—åŠ›éœ€æ±‚çˆ†å‘</div></div></div></div>
       <div className="absolute left-[70%] top-[30%] -translate-x-1/2 -translate-y-1/2 z-10"><div className="w-20 h-20 rounded-full bg-slate-800 border-2 border-indigo-500/50 flex flex-col items-center justify-center hover:scale-110 transition-transform cursor-pointer shadow-lg"><span className="text-xs text-indigo-300 font-bold">CPO å…‰æ¨¡å—</span><span className="text-xs text-rose-500 font-mono">+4.2%</span></div></div>
       <div className="absolute left-[70%] top-[70%] -translate-x-1/2 -translate-y-1/2 z-10"><div className="w-20 h-20 rounded-full bg-slate-800 border-2 border-indigo-500/50 flex flex-col items-center justify-center hover:scale-110 transition-transform cursor-pointer shadow-lg"><span className="text-xs text-indigo-300 font-bold">æ¶²å†·æœåŠ¡å™¨</span><span className="text-xs text-rose-500 font-mono">+3.8%</span></div></div>
       {['å…‰èŠ¯ç‰‡', 'PCB', 'å†·æ¿', 'æµ¸æ²¡å¼'].map((name, i) => (<div key={i} className={`absolute left-[85%] z-10 -translate-x-1/2 -translate-y-1/2`} style={{ top: `${20 + i * 20}%` }}><div className="px-3 py-1.5 bg-slate-800/80 border border-slate-700 rounded-full text-xs text-slate-300 hover:bg-slate-700 cursor-pointer whitespace-nowrap">{name} <span className="text-rose-400 ml-1">+{Math.floor(Math.random()*5)}%</span></div></div>))}
    </div>
);

const SmartMoneyChart = ({ data }) => (
    <div className="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-6 h-80 flex flex-col w-full">
       <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Briefcase className="text-violet-500" size={18}/> èªæ˜é’± vs å‚»ç“œé’±</h3><div className="flex gap-3 text-xs"><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-violet-500"></span> æœºæ„æƒ…ç»ª</span><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-gray-400"></span> æ•£æˆ·æƒ…ç»ª</span></div></div>
       <div className="flex-1 min-h-0"><ResponsiveContainer width="100%" height="100%"><LineChart data={data}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="time" hide /><YAxis hide domain={[-1.5, 1.5]} /><Tooltip /><Line type="monotone" dataKey="smartMoney" stroke="#8b5cf6" strokeWidth={2} dot={false} /><Line type="monotone" dataKey="dumbMoney" stroke="#94a3b8" strokeWidth={2} strokeDasharray="5 5" dot={false} /></LineChart></ResponsiveContainer></div>
       <p className="text-xs text-gray-500 mt-2 text-center bg-violet-50 py-1.5 rounded-lg border border-violet-100"><span className="font-bold text-violet-700">AI æ´å¯Ÿï¼š</span> å½“å‰å‡ºç°æ˜æ˜¾åº•èƒŒç¦»ï¼Œæ•£æˆ·ææ…Œç¦»åœºï¼Œæœºæ„æ­£åœ¨ä½ä½å¸ç­¹ã€‚</p>
    </div>
);

const SentimentPK = () => {
  const [vote, setVote] = useState(null); 
  return (
    <div className="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm w-full mb-6">
       <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Vote className="text-indigo-500" size={18}/> æƒ…ç»ª PK æ“‚å°</h3><span className="text-xs text-gray-400">1.2w äººå‚ä¸</span></div>
       <p className="text-xs text-gray-600 mb-4 text-center">ä½ è®¤ä¸ºæ˜æ—¥èµ°åŠ¿å¦‚ä½•ï¼Ÿ</p>
       <div className="flex gap-4"><button onClick={() => setVote('bull')} className={`flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 transition-all ${vote === 'bull' ? 'bg-rose-500 text-white border-rose-500' : 'bg-white border-rose-200 text-rose-500 hover:bg-rose-50'}`}><TrendingUpIcon size={16}/> çœ‹æ¶¨</button><button onClick={() => setVote('bear')} className={`flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 transition-all ${vote === 'bear' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-white border-emerald-200 text-emerald-500 hover:bg-emerald-50'}`}><TrendingDown size={16}/> çœ‹è·Œ</button></div>
       {vote && <div className="mt-4 pt-4 border-t border-gray-100"><div className="w-full h-2 bg-emerald-100 rounded-full overflow-hidden"><div className="h-full bg-rose-500" style={{width: '68%'}}></div></div><p className="text-[10px] text-gray-400 mt-2 text-center">æ‚¨çš„æŠ•ç¥¨å·²è®°å½•ï¼Œæˆ˜èƒœäº† 85% çš„ç”¨æˆ·</p></div>}
    </div>
  );
};

const BacktestView = () => (
  <div className="animate-in fade-in slide-in-from-right-4 duration-500 pb-12">
     <div className="bg-white border border-gray-200 rounded-2xl p-8 shadow-sm">
        <div className="flex justify-between items-start mb-8"><div><h2 className="text-2xl font-bold text-gray-900 mb-2">èˆ†æƒ…å› å­ç­–ç•¥å›æµ‹</h2><p className="text-sm text-gray-500">ç­–ç•¥é€»è¾‘ï¼šå½“èˆ†æƒ…å‡€å€¼ {'>'} 0.8 ä¸”ä¸»åŠ›å‡€æµå…¥è½¬æ­£æ—¶ä¹°å…¥ï¼›èˆ†æƒ…å‡€å€¼ {'<'} -0.5 æ—¶å–å‡ºã€‚</p></div><div className="text-right"><div className="text-3xl font-mono font-bold text-rose-500">+42.8%</div><div className="text-xs text-gray-400 uppercase">è¿‘ä¸€å¹´æ”¶ç›Šç‡</div></div></div>
        <div className="h-80 w-full mb-8"><ResponsiveContainer width="100%" height="100%"><LineChart data={BACKTEST_DATA}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><XAxis dataKey="day" tickLine={false} axisLine={false} /><YAxis domain={['auto', 'auto']} tickLine={false} axisLine={false} /><Tooltip contentStyle={{borderRadius:'8px'}} /><Line type="monotone" dataKey="strategy" stroke="#f43f5e" strokeWidth={3} dot={false} name="ç­–ç•¥å‡€å€¼" /><Line type="monotone" dataKey="benchmark" stroke="#94a3b8" strokeWidth={2} dot={false} name="åŸºå‡†æŒ‡æ•°" /></LineChart></ResponsiveContainer></div>
        <div className="grid grid-cols-4 gap-4">{[{l:'æœ€å¤§å›æ’¤',v:'-8.5%'}, {l:'å¤æ™®æ¯”ç‡',v:'2.1'}, {l:'èƒœç‡',v:'65%'}, {l:'ç›ˆäºæ¯”',v:'1.8'}].map((m,i)=>(<div key={i} className="bg-gray-50 p-4 rounded-xl text-center border border-gray-100"><div className="text-xs text-gray-400 mb-1">{m.l}</div><div className="text-lg font-bold text-gray-800">{m.v}</div></div>))}</div>
     </div>
  </div>
);

const AICopilotWidget = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([{ role: 'ai', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ Ripple AI åŠ©æ‰‹ã€‚ä½ å¯ä»¥é—®æˆ‘ï¼šâ€œä¸ºä»€ä¹ˆä»Šå¤©åŒ»è¯æ¿å—è·Œäº†ï¼Ÿâ€ æˆ–è€… â€œå¸®æˆ‘åˆ†æä¸€ä¸‹èŒ…å°çš„èµ„é‡‘æµâ€ã€‚' }]);
  const [input, setInput] = useState('');
  const handleSend = () => { if (!input.trim()) return; setMessages([...messages, { role: 'user', text: input }]); setInput(''); setTimeout(() => { setMessages(prev => [...prev, { role: 'ai', text: 'æ”¶åˆ°ï¼Œæ­£åœ¨åˆ†æå…¨ç½‘èˆ†æƒ…æ•°æ®... (æ¨¡æ‹Ÿå›ç­”ï¼šä¸»åŠ›èµ„é‡‘ä»Šæ—¥åœ¨åŒ»è¯æ¿å—å‘ˆç°å‡€æµå‡ºæ€åŠ¿ï¼Œä¸»è¦å—é›†é‡‡ä¼ é—»å½±å“ï¼Œææ…ŒæŒ‡æ•°ä¸Šå‡è‡³ 85ã€‚)' }]); }, 1000); };
  return (
    <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
      {isOpen && <div className="bg-white w-80 h-96 rounded-2xl shadow-2xl border border-gray-200 mb-4 flex flex-col overflow-hidden animate-in slide-in-from-bottom-5 fade-in duration-300"><div className="bg-gradient-to-r from-indigo-600 to-violet-600 p-4 text-white flex justify-between items-center"><div className="flex items-center gap-2"><Bot size={18}/> <span className="font-bold text-sm">Ripple Copilot</span></div><button onClick={() => setIsOpen(false)}><X size={16} className="opacity-80 hover:opacity-100"/></button></div><div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">{messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-xl text-xs leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-gray-200 text-gray-700 rounded-bl-none shadow-sm'}`}>{m.text}</div></div>))}</div><div className="p-3 border-t border-gray-100 bg-white flex gap-2"><input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500/50" /><button onClick={handleSend} className="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700"><Send size={14}/></button></div></div>}
      <button onClick={() => setIsOpen(!isOpen)} className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-full shadow-lg shadow-indigo-500/40 text-white flex items-center justify-center hover:scale-110 transition-transform">{isOpen ? <X size={24} /> : <Bot size={28} />}</button>
    </div>
  );
};

const ShareCardModal = ({ isOpen, onClose, stock }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md animate-in zoom-in-95">
      <div className="bg-gradient-to-br from-slate-900 to-slate-800 p-1 rounded-2xl shadow-2xl max-w-sm w-full"><div className="bg-slate-900 rounded-xl p-6 relative overflow-hidden text-center text-white border border-slate-700"><div className="absolute top-0 right-0 p-20 bg-indigo-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div><div className="flex justify-center mb-4"><div className="p-3 bg-indigo-500/20 rounded-full border border-indigo-500/50"><Waves size={32} className="text-indigo-400"/></div></div><h2 className="text-2xl font-bold mb-1">{stock.name}</h2><p className="text-indigo-400 font-mono text-sm mb-6">{stock.code}</p><div className="grid grid-cols-2 gap-4 mb-6"><div className="bg-slate-800 p-3 rounded-lg border border-slate-700"><div className="text-xs text-slate-400 mb-1">èˆ†æƒ…çƒ­åº¦</div><div className="text-xl font-bold text-rose-500">98,520</div></div><div className="bg-slate-800 p-3 rounded-lg border border-slate-700"><div className="text-xs text-slate-400 mb-1">AI è¯„çº§</div><div className="text-xl font-bold text-emerald-400">è¶…é…</div></div></div><div className="bg-indigo-600 text-white py-3 rounded-lg font-bold text-sm mb-4 cursor-pointer hover:bg-indigo-500 transition-colors">ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œ</div><button onClick={onClose} className="text-slate-500 text-xs hover:text-white">å…³é—­é¢„è§ˆ</button></div></div>
    </div>
  );
};

const EventDetailModal = ({ event, onClose }) => {
  if (!event) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div className="relative h-32 bg-gradient-to-r from-indigo-600 to-violet-600 p-6 flex flex-col justify-end"><button onClick={onClose} className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors"><X size={20} /></button><div className="flex items-center gap-3 mb-2"><span className="bg-white/20 backdrop-blur-md px-2 py-0.5 rounded text-xs font-bold text-white flex items-center gap-1"><Calendar size={12} /> {event.date}</span><span className="bg-orange-500/90 px-2 py-0.5 rounded text-xs font-bold text-white flex items-center gap-1"><Clock size={12} /> å€’è®¡æ—¶ {event.daysLeft} å¤©</span></div><h2 className="text-2xl font-bold text-white">{event.title}</h2></div>
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          <div><h3 className="text-sm font-bold text-gray-900 flex items-center gap-2 mb-2"><Info size={16} className="text-indigo-600" /> äº‹ä»¶èƒŒæ™¯</h3><p className="text-sm text-gray-600 leading-relaxed bg-gray-50 p-3 rounded-lg border border-gray-100">{event.description}</p></div>
          <div><h3 className="text-sm font-bold text-gray-900 flex items-center gap-2 mb-2"><Sparkles size={16} className="text-violet-600 fill-violet-600" /> Gemini æ·±åº¦æ¨æ¼”</h3><div className="bg-gradient-to-br from-violet-50 to-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-gray-700 leading-relaxed shadow-sm">{event.aiAnalysis}</div></div>
          <div><h3 className="text-sm font-bold text-gray-900 flex items-center gap-2 mb-3"><Link size={16} className="text-emerald-600" /> æ ¸å¿ƒå…³è”èµ„äº§</h3><div className="space-y-2">{event.relatedAssets && event.relatedAssets.map((stock, idx) => (<div key={idx} className="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:border-indigo-300 transition-colors"><div className="flex flex-col"><div className="flex items-center gap-2"><span className="font-bold text-gray-800 text-sm">{stock.name}</span><span className="text-xs text-gray-400 font-mono">{stock.code}</span></div><span className="text-xs text-gray-500 mt-1">{stock.logic}</span></div><div className="flex items-center gap-4 text-right"><div><div className="text-[10px] text-gray-400">ç›¸å…³åº¦</div><div className="text-xs font-bold text-indigo-600">{(stock.correlation * 100).toFixed(0)}%</div></div><div><div className="text-[10px] text-gray-400">ç°ä»·</div><div className={`text-sm font-bold font-mono ${stock.change > 0 ? 'text-rose-600' : 'text-emerald-600'}`}>{stock.price} ({stock.change > 0 ? '+' : ''}{stock.change}%)</div></div></div></div>))}</div></div>
        </div>
      </div>
    </div>
  );
};

const ExportConfigModal = ({ isOpen, onClose, stock, onGenerate }) => {
  if (!isOpen || !stock) return null;
  const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
  const [startTime, setStartTime] = useState("09:00");
  const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
  const [endTime, setEndTime] = useState("15:00");
  const [options, setOptions] = useState({ volumeTrend: true, keywordCloud: true, mediaStats: true, aiRating: true });
  return (<div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200"><div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 overflow-hidden"><div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Download size={18} className="text-indigo-600" /> å¯¼å‡ºèˆ†æƒ…æ·±åº¦ç ”æŠ¥</h3><button onClick={onClose}><X size={20} className="text-gray-400 hover:text-gray-600"/></button></div><div className="p-6 space-y-6"><div className="flex items-center gap-3 p-3 bg-indigo-50 border border-indigo-100 rounded-lg"><div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs">{stock.code.substring(0,2)}</div><div><div className="font-bold text-gray-900">{stock.name}</div><div className="text-xs text-gray-500">æ­£åœ¨ç”Ÿæˆè¯¥æ ‡çš„çš„èˆ†æƒ…é‡åŒ–åˆ†ææŠ¥å‘Š</div></div></div><div><label className="text-xs font-bold text-gray-500 uppercase mb-2 block">æ—¶é—´çª—å£</label><div className="grid grid-cols-2 gap-4"><div><span className="text-[10px] text-gray-400">å¼€å§‹</span><div className="flex gap-2"><input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full text-xs border rounded p-1.5" /><input type="time" value={startTime} onChange={e=>setStartTime(e.target.value)} className="w-16 text-xs border rounded p-1.5" /></div></div><div><span className="text-[10px] text-gray-400">ç»“æŸ</span><div className="flex gap-2"><input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full text-xs border rounded p-1.5" /><input type="time" value={endTime} onChange={e=>setEndTime(e.target.value)} className="w-16 text-xs border rounded p-1.5" /></div></div></div></div><div><label className="text-xs font-bold text-gray-500 uppercase mb-2 block">æ•°æ®ç»´åº¦</label><div className="grid grid-cols-2 gap-3">{['å£°é‡è¶‹åŠ¿', 'å…³é”®è¯äº‘', 'åª’ä½“ç»Ÿè®¡', 'AI è¯„çº§'].map((label,i)=><label key={i} className="flex items-center gap-2 cursor-pointer"><input type="checkbox" defaultChecked className="accent-indigo-600" /><span className="text-sm text-gray-700">{label}</span></label>)}</div></div></div><div className="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded-lg">å–æ¶ˆ</button><button onClick={() => onGenerate({stock, timeRange:{start:startDate, end:endDate}, options})} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium flex items-center gap-2"><FileCheck size={16}/> å¼€å§‹ç”Ÿæˆ</button></div></div></div>);
};

const GeneratedReportModal = ({ isOpen, onClose, reportData }) => {
  if (!isOpen || !reportData) return null;
  return (<div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md animate-in zoom-in-95 duration-300"><div className="bg-white w-full max-w-4xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden"><div className="h-14 bg-slate-800 flex justify-between items-center px-6 text-white shrink-0"><div className="flex items-center gap-2"><FileText size={18} className="text-indigo-400" /><span className="font-bold text-sm">ç ”æŠ¥é¢„è§ˆ</span><span className="text-slate-500 text-xs ml-2">Generated by Gemini 2.5</span></div><div className="flex gap-3"><button className="px-3 py-1.5 bg-indigo-600 rounded text-xs">æ‰“å°</button><button className="px-3 py-1.5 bg-white text-slate-900 rounded text-xs">ä¸‹è½½ PDF</button><button onClick={onClose}><X size={20} className="text-slate-400 hover:text-white"/></button></div></div><div className="flex-1 overflow-y-auto bg-gray-100 p-8 custom-scrollbar"><div className="max-w-3xl mx-auto bg-white shadow-lg min-h-[1000px] p-12 relative"><div className="border-b-2 border-indigo-600 pb-6 mb-8 flex justify-between items-start"><div><h1 className="text-3xl font-bold text-gray-900 mb-2">{reportData.stock.name} èˆ†æƒ…æ·±åº¦æŠ¥å‘Š</h1><div className="text-sm text-gray-500">ç”Ÿæˆæ—¶é—´: {new Date().toLocaleString()}</div></div><div className="text-right"><div className="text-2xl font-bold text-indigo-600 flex items-center justify-end gap-2"><Waves size={24}/> æ³¢çº¹ Ripple</div></div></div><div className="grid grid-cols-3 gap-6 mb-10 bg-slate-50 p-6 rounded-xl border border-slate-100"><div className="text-center border-r border-gray-200"><div className="text-sm text-gray-500 uppercase mb-2">èˆ†æƒ… Alpha</div><div className="text-5xl font-extrabold text-rose-600">8.4</div></div><div className="text-center border-r border-gray-200"><div className="text-sm text-gray-500 uppercase mb-2">AI è¯„çº§</div><div className="text-3xl font-bold text-gray-800 mt-2">è¶…é…</div></div><div className="pl-4 flex flex-col justify-center gap-2"><div className="text-xs text-gray-500">æ•£æˆ·çƒ­åº¦ <span className="text-orange-500 font-bold">High</span></div><div className="w-full bg-gray-200 h-1.5 rounded-full"><div className="bg-orange-500 h-1.5 rounded-full" style={{width:'85%'}}></div></div></div></div><div className="mb-10"><h3 className="text-lg font-bold text-gray-900 border-l-4 border-indigo-600 pl-3 mb-4">ç»¼åˆè¯„ä»·</h3><p className="text-sm text-gray-700 leading-relaxed">åœ¨é€‰å®šçš„æ—¶é—´çª—å£å†…ï¼Œè¯¥æ ‡çš„å‘ˆç°â€œé‡ä»·é½å‡â€æ€åŠ¿ã€‚è®¨è®ºçƒ­åº¦ç¯æ¯”æ¿€å¢ 145%ï¼Œå»ºè®®å…³æ³¨åç»­èµ„é‡‘æ‰¿æ¥æƒ…å†µã€‚</p></div></div></div></div></div>);
};

const EventCard = ({ event, onClick }) => {
  const isRisk = event.prediction === 'risk';
  const isOpportunity = event.prediction === 'opportunity';
  return (<div onClick={() => onClick(event)} className={`relative bg-white border rounded-xl p-4 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all group overflow-hidden cursor-pointer ${isRisk ? 'border-l-4 border-l-emerald-500' : isOpportunity ? 'border-l-4 border-l-rose-500' : 'border-l-4 border-l-gray-300'}`}><div className="flex justify-between items-start mb-3"><div className="flex items-center gap-2"><div className="bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600 flex items-center gap-1"><Calendar size={12} /> {event.date}</div>{event.daysLeft <= 3 && <span className="bg-red-100 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded animate-pulse">å€’è®¡æ—¶ {event.daysLeft} å¤©</span>}</div><div className={`text-xs font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${isRisk ? 'bg-emerald-50 text-emerald-700' : isOpportunity ? 'bg-rose-50 text-rose-700' : 'bg-gray-100 text-gray-600'}`}>{isRisk ? <AlertTriangle size={10} /> : isOpportunity ? <Target size={10} /> : <Activity size={10} />}{isRisk ? 'é«˜ä½é£é™©' : isOpportunity ? 'æ½œä¼æœºä¼š' : 'ä¸­æ€§è§‚æœ›'}</div></div><h4 className="font-bold text-gray-900 text-sm mb-1 group-hover:text-indigo-600 transition-colors flex items-center justify-between">{event.title}<ArrowRight size={14} className="opacity-0 group-hover:opacity-100 transition-opacity text-indigo-400" /></h4><div className="text-xs text-gray-500 mb-3 flex items-center gap-1">å…³è”{event.type === 'sector' ? 'æ¿å—' : 'ä¸ªè‚¡'}: <span className="font-bold text-indigo-600">{event.target}</span></div><div className="grid grid-cols-3 gap-2 bg-gray-50 p-2 rounded-lg mb-3"><div><div className="text-[10px] text-gray-400 flex items-center gap-1"><Megaphone size={10}/> åª’ä½“å£°é‡</div><div className="text-xs font-bold text-gray-800 mt-0.5">{event.mediaHeat}</div></div><div><div className="text-[10px] text-gray-400 flex items-center gap-1"><Banknote size={10}/> èµ„é‡‘æµå‘</div><div className={`text-xs font-bold mt-0.5 ${event.fundFlow.includes('-') ? 'text-emerald-600' : 'text-rose-600'}`}>{event.fundFlow}</div></div><div><div className="text-[10px] text-gray-400 flex items-center gap-1"><TrendingUp size={10}/> è¿‘æœŸæ¶¨å¹…</div><div className={`text-xs font-bold mt-0.5 ${event.priceChange.includes('-') ? 'text-emerald-600' : 'text-rose-600'}`}>{event.priceChange}</div></div></div><div className="flex items-start gap-2"><Sparkles size={12} className="text-indigo-500 mt-0.5 shrink-0" /><p className="text-xs text-gray-600 leading-tight"><span className="font-bold text-indigo-700">AI é¢„æµ‹ï¼š</span>{event.summary}</p></div></div>);
};
const NewsRow = ({ data, index }) => (<div className="flex items-center justify-between p-3.5 border-b border-gray-50 hover:bg-gray-50/50 transition-colors group"><div className="flex items-start gap-3 flex-1 min-w-0"><div className={`flex-shrink-0 w-5 h-5 flex items-center justify-center rounded text-[10px] font-bold ${index < 3 ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-500'}`}>{index + 1}</div><div className="flex-1 min-w-0"><a href={data.url} target="_blank" rel="noopener noreferrer" className="block text-sm font-medium text-gray-800 hover:text-indigo-600 truncate transition-colors mb-1">{data.title}</a><div className="flex items-center gap-2 text-[10px] text-gray-400"><span className="bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{data.source}</span><span className="flex items-center gap-1"><Clock size={10} /> {data.time}</span><span className={`px-1.5 py-0.5 rounded font-medium ${data.sentiment === 'pos' ? 'bg-rose-50 text-rose-600' : data.sentiment === 'neg' ? 'bg-emerald-50 text-emerald-600' : 'bg-gray-100 text-gray-500'}`}>{data.sentiment === 'pos' ? 'åˆ©å¤š' : data.sentiment === 'neg' ? 'åˆ©ç©º' : 'ä¸­æ€§'}</span></div></div></div><div className="flex items-center gap-4 pl-4"><div className="text-right"><div className="flex items-center gap-1 justify-end text-[10px] font-bold text-orange-500 mb-0.5"><Flame size={10} className="fill-orange-500" />{(data.heat / 10000).toFixed(1)}w</div><div className="w-16 h-1 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-orange-300 to-red-500" style={{width: `${Math.min(data.heat / 1000, 100)}%`}}></div></div></div><a href={data.url} target="_blank" rel="noopener noreferrer" className="p-1.5 text-gray-300 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all opacity-0 group-hover:opacity-100"><ExternalLink size={14} /></a></div></div>);
const CommentRow = ({ user, text, score, time, platform, onAnalyze }) => { const [analyzing, setAnalyzing] = useState(false); const [analysis, setAnalysis] = useState(null); const handleAnalyze = async () => { if (analysis) { setAnalysis(null); return; } setAnalyzing(true); const result = await onAnalyze(text); setAnalysis(result); setAnalyzing(false); }; return (<div className="group flex flex-col border-b border-gray-50 hover:bg-gray-50/80 transition-colors px-4 py-3"><div className="flex gap-3"><div className="flex-shrink-0 pt-0.5"><div className="w-7 h-7 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-600 font-bold text-[10px] shadow-inner border border-white">{user[0]}</div></div><div className="flex-1 min-w-0"><div className="flex justify-between items-center mb-1"><div className="flex items-center gap-2"><span className="text-xs font-semibold text-gray-900">{user}</span><span className="text-[9px] text-gray-500 px-1 py-0.5 bg-white border border-gray-200 rounded font-medium">{platform}</span></div><span className="text-[10px] text-gray-400 font-mono">{time}</span></div><p className="text-xs text-gray-600 leading-relaxed group-hover:text-gray-900 transition-colors">{text}</p>{analysis && <div className="mt-2 p-2 bg-indigo-50/60 border border-indigo-100 rounded text-[10px] text-indigo-800 animate-in fade-in slide-in-from-top-1 shadow-sm"><span className="font-bold flex items-center gap-1 mb-0.5 text-indigo-600"><Sparkles size={10} className="fill-indigo-600" /> AI æ„å›¾æ´å¯Ÿ</span>{analysis}</div>}</div><div className="flex flex-col items-end justify-start min-w-[40px] gap-1 pt-0.5"><div className="text-center"><span className={`text-xs font-bold font-mono ${score > 0 ? 'text-rose-500' : 'text-emerald-500'}`}>{score > 0 ? '+' : ''}{score}</span></div><button onClick={handleAnalyze} disabled={analyzing} className="p-1 rounded-full text-gray-300 hover:text-indigo-600 hover:bg-indigo-50 transition-all opacity-0 group-hover:opacity-100">{analyzing ? <Loader2 size={12} className="animate-spin text-indigo-600" /> : <Sparkles size={12} />}</button></div></div></div>); };
const SentimentLeaderboard = ({ onStockClick }) => (<div className="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-500"><div className="p-6 border-b border-gray-50 bg-gradient-to-r from-white to-gray-50 flex justify-between items-center"><div><h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Trophy className="text-amber-500 fill-amber-500" size={20} /> èˆ†æƒ…é¾™è™æ¦œ (Sentiment 100)</h3><p className="text-xs text-gray-500 mt-1">å…¨ç½‘å£°é‡å®æ—¶æ’åï¼ŒAI è¯†åˆ«æ ¸å¿ƒé©±åŠ¨åŠ›</p></div><div className="flex gap-2"><span className="text-[10px] bg-rose-50 text-rose-600 px-2 py-1 rounded font-medium border border-rose-100">ğŸ”¥ æƒ…ç»ªè¿‡çƒ­åŒº</span><span className="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded font-medium border border-emerald-100">â„ï¸ æƒ…ç»ªå†°ç‚¹åŒº</span></div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100"><tr><th className="px-6 py-4 w-16 text-center">æ’å</th><th className="px-6 py-4">æ ‡çš„åç§°</th><th className="px-6 py-4">æœ€æ–°ä»· / æ¶¨è·Œå¹…</th><th className="px-6 py-4 w-48">å…¨ç½‘å£°é‡çƒ­åº¦</th><th className="px-6 py-4">AI æƒ…ç»ªå€¾å‘</th><th className="px-6 py-4">æ ¸å¿ƒé©±åŠ¨é¢˜æ</th><th className="px-6 py-4 text-right">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-gray-50">{SENTIMENT_LEADERBOARD.map((item, index) => {const stockObj = STOCKS.find(s => s.code === item.code) || { ...item, marketVal: '1000B' };return (<tr key={item.code} onClick={() => onStockClick(stockObj)} className="hover:bg-indigo-50/30 transition-colors cursor-pointer group"><td className="px-6 py-4 text-center">{index < 3 ? <div className={`w-6 h-6 mx-auto rounded-full flex items-center justify-center text-xs font-bold text-white shadow-sm ${index === 0 ? 'bg-amber-400' : index === 1 ? 'bg-slate-400' : 'bg-orange-700'}`}>{item.rank}</div> : <span className="text-gray-400 font-mono font-medium">{item.rank}</span>}</td><td className="px-6 py-4"><div className="font-bold text-gray-900 group-hover:text-indigo-600 transition-colors">{item.name}</div><div className="text-xs text-gray-400 font-mono">{item.code}</div></td><td className="px-6 py-4"><div className="font-mono font-medium text-gray-800">{item.price.toFixed(2)}</div><div className={`text-xs font-bold ${item.change > 0 ? 'text-rose-500' : 'text-emerald-500'}`}>{item.change > 0 ? '+' : ''}{item.change}%</div></td><td className="px-6 py-4"><div className="flex items-center gap-2 mb-1"><Flame size={12} className={`fill-current ${index < 3 ? 'text-rose-500' : 'text-orange-400'}`} /><span className="text-xs font-bold font-mono text-gray-700">{(item.heat / 10000).toFixed(1)}w</span></div><div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden"><div className={`h-full rounded-full ${index < 3 ? 'bg-gradient-to-r from-rose-400 to-red-600' : 'bg-orange-300'}`} style={{ width: `${Math.min(item.heat / 1000, 100)}%` }}></div></div></td><td className="px-6 py-4"><div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold border ${item.sentiment > 0.5 ? 'bg-rose-50 text-rose-600 border-rose-100' : item.sentiment < -0.5 ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-gray-50 text-gray-600 border-gray-200'}`}>{item.sentiment > 0.5 ? <TrendingUpIcon size={12} /> : item.sentiment < -0.5 ? <AlertCircle size={12} /> : <Activity size={12} />}{item.sentiment > 0.5 ? 'æåº¦çœ‹å¤š' : item.sentiment < -0.5 ? 'ææ…ŒæŠ›å”®' : 'å¤šç©ºåšå¼ˆ'}</div></td><td className="px-6 py-4"><div className="flex flex-col gap-1"><span className="text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded w-fit border border-indigo-100">#{item.tag}</span><span className="text-[10px] text-gray-400 truncate max-w-[180px]" title={item.reason}>{item.reason}</span></div></td><td className="px-6 py-4 text-right"><button className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all group-hover:translate-x-1"><ArrowRight size={18} /></button></td></tr>);})}</tbody></table></div></div>);

// 5. ä¸»ç¨‹åº

export default function SentimentPlatformRefactored() {
  const [activeTab, setActiveTab] = useState('market'); 
  const [selectedStock, setSelectedStock] = useState(STOCKS[0]);
  const [chartData, setChartData] = useState([]);
  const [comments, setComments] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [showSuggestions, setShowSuggestions] = useState(false);
  const searchContainerRef = useRef(null);
  
  // States
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [isExportModalOpen, setIsExportModalOpen] = useState(false);
  const [isReportViewOpen, setIsReportViewOpen] = useState(false);
  const [generatedReportData, setGeneratedReportData] = useState(null);
  const [isGeneratingExport, setIsGeneratingExport] = useState(false);
  const [isGeneratingReport, setIsGeneratingReport] = useState(false);
  const [reportData, setReportData] = useState({ summary: 'ç‚¹å‡»ä¸Šæ–¹ "ç”Ÿæˆ AI ç®€æŠ¥" æŒ‰é’®...', bullCase: [], riskFactor: [], generatedAt: null });
  const [marketReport, setMarketReport] = useState({ summary: '', strategy: '', generatedAt: null });
  const [isShareOpen, setIsShareOpen] = useState(false);
  const [vote, setVote] = useState(null);
  
  // Time
  const [currentTime, setCurrentTime] = useState(INITIAL_MOCK_TIME);
  const [marketStatus, setMarketStatus] = useState(getMarketStatus(INITIAL_MOCK_TIME));

  // Init Data
  useEffect(() => {
    setChartData(generateChartData());
    setComments([
      { id: 1, user: 'è€æ³•å¸ˆ', text: 'ä»ç›˜å£çœ‹ï¼Œå¤§å•ä¹°å…¥éå¸¸åšå†³ï¼Œä¸‹åˆå¤§æ¦‚ç‡æ¶¨åœã€‚', score: 0.85, time: '10:42', platform: 'é›ªçƒ' },
      { id: 2, user: 'éŸ­èœ101', text: 'åˆæ˜¯è¯±å¤šï¼Œå¤§å®¶åƒä¸‡åˆ«ä¸Šå½“ï¼', score: -0.62, time: '10:41', platform: 'è‚¡å§' },
      { id: 3, user: 'Quant_X', text: 'æƒ…ç»ªæŒ‡æ ‡å·²ç»èƒŒç¦»ï¼Œä»·æ ¼ç¨åä¼šè·Ÿä¸Šã€‚', score: 0.45, time: '10:40', platform: 'å¾®åš' },
    ]);
    const timer = setInterval(() => {
      setCurrentTime(prev => { const newTime = new Date(prev.getTime() + 60000); setMarketStatus(getMarketStatus(newTime)); return newTime; });
    }, 1000);
    return () => clearInterval(timer);
  }, [selectedStock]);

  useEffect(() => {
    if (marketStatus.status === 'trading' || marketStatus.status === 'auction') {
      setChartData(prev => {
        const last = prev[prev.length-1];
        const newData = {
          time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}),
          price: parseFloat((last.price + (Math.random() - 0.5) * 2).toFixed(2)),
          sentiment: parseFloat(((Math.random() * 2 - 1) * 0.2 + last.sentiment * 0.8).toFixed(2)),
          smartMoney: parseFloat((last.smartMoney + (Math.random() - 0.5) * 0.1).toFixed(2)),
          dumbMoney: parseFloat((last.dumbMoney + (Math.random() - 0.5) * 0.2).toFixed(2)),
          volume: Math.floor(Math.random() * 2000) + 1000
        };
        return [...prev.slice(1), newData];
      });
    }
  }, [currentTime, marketStatus.status]);

  // Handlers
  const filteredStocks = STOCKS.filter(stock => stock.code.includes(searchQuery) || stock.name.includes(searchQuery));
  const currentSentiment = chartData.length > 0 ? chartData[chartData.length-1].sentiment : 0;

  const handleAnalyzeComment = async (text) => new Promise(resolve => setTimeout(() => resolve("AIåˆ†æï¼šå…¸å‹çš„FOMOæƒ…ç»ªï¼Œå»ºè®®è§‚æœ›ã€‚"), 1000));
  const handleGenerateStockReport = async () => { setIsGeneratingReport(true); setTimeout(() => { setReportData({ summary: 'å½“å‰èˆ†æƒ…å‘ˆç°å¤šå¤´æ’åˆ—ï¼Œå»ºè®®å³ä¾§äº¤æ˜“ã€‚', bullCase: ['èµ„é‡‘å‡€æµå…¥', 'ä¸šç»©è¶…é¢„æœŸ'], riskFactor: ['é«˜ä½è·åˆ©ç›˜', 'é‡èƒ½èç¼©'], generatedAt: new Date().toLocaleTimeString() }); setIsGeneratingReport(false); }, 1500); };
  const handleGenerateMarketReport = async () => { setIsGeneratingReport(true); setTimeout(() => { setMarketReport({ summary: 'å¸‚åœºæƒ…ç»ªå›æš–ï¼Œé¢˜æè‚¡æ´»è·ƒã€‚', strategy: 'è½»æŒ‡æ•°ï¼Œé‡ä¸ªè‚¡ï¼Œå…³æ³¨ç§‘æŠ€ä¸»çº¿ã€‚', generatedAt: new Date().toLocaleTimeString() }); setIsGeneratingReport(false); }, 1500); };
  const handleExportClick = () => setIsExportModalOpen(true);
  const handleConfirmExport = (config) => { setIsExportModalOpen(false); setIsGeneratingExport(true); setTimeout(() => { setGeneratedReportData({ stock: config.stock, timeRange: config.timeRange, options: config.options }); setIsGeneratingExport(false); setIsReportViewOpen(true); }, 2000); };
  const handleLeaderboardClick = (stock) => { setSelectedStock(stock); setActiveTab('stock'); setReportData({ summary: 'ç­‰å¾…ç”Ÿæˆ...', bullCase: [], riskFactor: [], generatedAt: null }); };
  const MarketStatusIcon = marketStatus.icon;

  // DB Simulation Button Handler (Mock DB Injection)
  const handleSimulateDbInjection = () => {
    const newComment = {
      id: Date.now(),
      user: 'æ¨¡æ‹Ÿæ•°æ®æº',
      text: 'DB: åˆšåˆšæŠ“å–åˆ°ä¸€æ¡æ¥è‡ª [æ·˜è‚¡å§] çš„ä¸»åŠ›å¤ç›˜è´´ï¼Œæ­£åœ¨åŒæ­¥...',
      score: 0.99,
      time: new Date().toLocaleTimeString(),
      platform: 'DB_SYNC'
    };
    setComments(prev => [newComment, ...prev]);
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] text-slate-900 font-sans antialiased selection:bg-indigo-100 selection:text-indigo-900">
      
      {/* Modals & Overlays */}
      {selectedEvent && <EventDetailModal event={selectedEvent} onClose={() => setSelectedEvent(null)} />}
      <ExportConfigModal isOpen={isExportModalOpen} onClose={() => setIsExportModalOpen(false)} stock={selectedStock} onGenerate={handleConfirmExport} />
      <GeneratedReportModal isOpen={isReportViewOpen} onClose={() => setIsReportViewOpen(false)} reportData={generatedReportData} />
      {isGeneratingExport && <div className="fixed inset-0 z-[120] flex flex-col items-center justify-center bg-slate-900/50 backdrop-blur-sm"><Loader2 size={48} className="text-white animate-spin mb-4" /><div className="text-white font-bold text-lg">AI æ­£åœ¨ç”Ÿæˆèˆ†æƒ…æ·±åº¦åˆ†ææŠ¥å‘Š...</div><div className="text-white/70 text-sm mt-2">æ­£åœ¨æ¸…æ´—æ•°æ®ã€è®¡ç®—æƒ…ç»ªAlphaã€ç”ŸæˆæŠ•èµ„è¯„çº§</div></div>}
      <AICopilotWidget />
      <ShareCardModal isOpen={isShareOpen} onClose={() => setIsShareOpen(false)} stock={selectedStock} />
      
      {/* DB Simulation Button */}
      <button onClick={handleSimulateDbInjection} className="fixed bottom-6 left-6 z-50 px-4 py-2 bg-slate-800 text-white text-xs font-mono rounded-lg shadow-lg hover:bg-slate-700 flex items-center gap-2 border border-slate-600"><Database size={14} className="text-emerald-400"/> ğŸ› ï¸ æ¨¡æ‹Ÿåç«¯æ¨é€</button>

      {/* Nav */}
      <nav className="h-16 bg-white/80 backdrop-blur-md border-b border-gray-200/80 fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-6">
        <div className="flex items-center gap-2.5"><div className="bg-gradient-to-tr from-indigo-600 to-violet-600 p-2 rounded-lg shadow-sm"><Waves className="text-white w-4 h-4" /></div><span className="text-lg font-bold tracking-tight text-gray-900">æ³¢çº¹<span className="text-indigo-600">Ripple</span> v4.6</span></div>
        <div className="hidden md:flex items-center gap-1 bg-gray-100 p-1 rounded-lg border border-gray-200">
          {[{id:'market',icon:LayoutGrid,label:'å¤§ç›˜'}, {id:'leaderboard',icon:Trophy,label:'é¾™è™æ¦œ'}, {id:'graph',icon:Network,label:'äº§ä¸šé“¾'}, {id:'stock',icon:Target,label:'ä¸ªè‚¡'}, {id:'backtest',icon:History,label:'å›æµ‹'}].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 transition-all ${activeTab === tab.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}><tab.icon size={14}/> {tab.label}</button>
          ))}
        </div>
        <div className="flex items-center gap-4"><div className="relative group" ref={searchContainerRef}><div className="flex items-center bg-gray-100/80 border border-gray-200 rounded-lg px-3 py-1.5 w-56 hover:w-64 focus-within:w-64 transition-all"><Search className="w-3.5 h-3.5 text-gray-400" /><input type="text" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} onFocus={()=>setShowSuggestions(true)} placeholder="æœç´¢ä»£ç ..." className="bg-transparent border-none outline-none text-xs w-full ml-2" /></div>{showSuggestions && searchQuery && <div className="absolute top-full mt-2 right-0 bg-white border border-gray-100 rounded-xl shadow-xl py-1 z-50 w-64">{filteredStocks.length > 0 ? filteredStocks.map(s => <div key={s.code} onClick={() => { setSelectedStock(s); setActiveTab('stock'); setSearchQuery(''); setShowSuggestions(false); }} className="px-3 py-2 hover:bg-indigo-50 cursor-pointer flex justify-between text-xs"><span>{s.name}</span><span>{s.code}</span></div>) : <div className="px-3 py-2 text-xs text-gray-400 text-center">æ— ç»“æœ</div>}</div>}</div><div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-100 to-violet-100 border border-white shadow-sm flex items-center justify-center text-xs font-bold text-indigo-700">VIP</div></div>
      </nav>

      {/* Status Bar */}
      <div className={`fixed top-16 left-0 right-0 h-8 ${marketStatus.color} text-white flex items-center justify-center text-xs font-medium z-40 shadow-sm transition-colors duration-500`}><div className="flex items-center gap-4"><span className="flex items-center gap-1.5"><Clock size={12}/> {currentTime.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}</span><span className="w-px h-3 bg-white/30"></span><span className="flex items-center gap-1.5 uppercase tracking-wide"><MarketStatusIcon size={12}/> {marketStatus.label}</span><span className="w-px h-3 bg-white/30"></span><span className="opacity-90">{marketStatus.message}</span></div></div>

      <main className="pt-28 pb-12 px-6 lg:px-10 max-w-[1600px] mx-auto">
        
        {/* MARKET TAB */}
        {activeTab === 'market' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
             <div className="grid grid-cols-4 gap-4 mb-8">{INDICES.map(idx => (<div key={idx.code} className="bg-white border border-gray-100/80 rounded-xl p-4 shadow-sm"><div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-500">{idx.name}</span><span className={`text-xs font-bold px-1.5 py-0.5 rounded ${idx.change > 0 ? 'bg-rose-50 text-rose-600' : 'bg-emerald-50 text-emerald-600'}`}>{idx.change > 0 ? '+' : ''}{idx.change}%</span></div><div className="flex justify-between items-end"><span className="text-2xl font-bold text-gray-900 font-feature-settings-tnum">{idx.value}</span><span className="text-xs text-gray-400 mb-1">Vol: {idx.volume}</span></div></div>))}</div>
             <div className="grid grid-cols-12 gap-6 h-[240px] mb-6">
                <div className="col-span-4 bg-white border border-gray-100 rounded-2xl p-6 shadow-sm flex flex-col justify-center items-center relative overflow-hidden"><h3 className="absolute top-4 left-4 text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2"><Thermometer size={14} className="text-rose-500"/> å¸‚åœºæƒ…ç»ª</h3><div className="w-full h-full flex items-center justify-center"><GaugeChart value={marketStatus.status === 'break' ? 50 : 78} /></div></div>
                <div className="col-span-5 grid grid-cols-2 gap-4">
                   <EnhancedMetricCard title="ä¸Šæ¶¨å®¶æ•°" value="3,840" subValue="72%" trend="up" icon={TrendingUpIcon} colorClass="text-rose-500" bgClass="bg-rose-50" />
                   <EnhancedMetricCard title="æ¶¨åœå®¶æ•°" value="68" subValue="+12" trend="up" icon={Flame} colorClass="text-orange-500" bgClass="bg-orange-50" type="heat" />
                </div>
                <div className="col-span-3 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl p-6 text-white flex flex-col justify-between shadow-lg shadow-indigo-200"><div><h4 className="text-xs font-bold text-indigo-100 uppercase tracking-wider mb-2">AI ç­–ç•¥å»ºè®®</h4><div className="text-2xl font-bold">è½»æŒ‡æ•° é‡ä¸ªè‚¡</div><div className="text-xs text-indigo-100 mt-1">å…³æ³¨ç§‘æŠ€æˆé•¿ä¸»çº¿</div></div><div className="bg-white/20 backdrop-blur-md rounded-lg p-3 text-xs font-medium leading-relaxed"><Sparkles size={12} className="inline mr-1"/> çŸ­æœŸæƒ…ç»ªå…±æŒ¯ï¼Œä¸Šæ¶¨æ¦‚ç‡ 72%</div></div>
             </div>
             <div className="mt-6 mb-6"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2 text-lg"><Target className="text-rose-500" size={20} /> æ™ºèƒ½äº‹ä»¶é›·è¾¾</h3><button onClick={() => setActiveTab('market-events')} className="flex items-center gap-1 text-xs text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded transition-colors">æŸ¥çœ‹æ›´å¤š <ChevronRight size={12} /></button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">{UPCOMING_EVENTS_BRIEF.map(event => <EventCard key={event.id} event={event} onClick={setSelectedEvent} />)}</div></div>
             <div className="mt-6 mb-6 bg-white border border-gray-100 rounded-2xl p-6 shadow-sm"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-900 flex items-center gap-2 text-lg"><PieChartIcon className="text-amber-500" size={20} /> é¢†æ¶¨æ¿å—çƒ­åŠ›</h3><button onClick={() => setActiveTab('market-sectors')} className="flex items-center gap-1 text-xs text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded transition-colors">æ›´å¤šæ¿å— <ChevronRight size={12} /></button></div><table className="w-full text-sm text-left"><thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100"><tr><th className="px-4 py-3">æ¿å—åç§°</th><th className="px-4 py-3">çƒ­åº¦æŒ‡æ•°</th><th className="px-4 py-3">æ¶¨è·Œå¹…</th><th className="px-4 py-3 text-right">ä¸»åŠ›å‡€æµå…¥</th></tr></thead><tbody>{SECTORS_BRIEF.map((sec, i) => <tr key={i} className="hover:bg-gray-50"><td className="px-4 py-3 font-bold">{sec.name}</td><td className="px-4 py-3"><div className="w-24 h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-orange-300 to-rose-500" style={{width: `${sec.hot}%`}}></div></div></td><td className="px-4 py-3 text-rose-500 font-bold">+{sec.change}%</td><td className="px-4 py-3 text-right text-rose-500 font-mono">{sec.netInflow}</td></tr>)}</tbody></table></div>
             <div className="mt-6 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl p-8 text-white shadow-lg"><div className="flex justify-between items-start mb-4"><h3 className="font-bold text-xl tracking-tight flex items-center gap-2"><Sparkles className="text-yellow-300"/> Gemini å¸‚åœºç­–ç•¥</h3><button onClick={handleGenerateMarketReport} disabled={isGeneratingReport} className="px-4 py-1.5 bg-white/20 rounded-full text-xs font-bold hover:bg-white/30 transition-colors">{isGeneratingReport?'ç”Ÿæˆä¸­...':'åˆ·æ–°ç­–ç•¥'}</button></div><p className="text-indigo-100 text-sm leading-relaxed mb-6">{marketReport.summary || 'Gemini æ­£åœ¨æ‰«æå…¨å¸‚åœºæ•°æ®...'}</p>{marketReport.strategy && <div className="bg-white/10 p-4 rounded-xl border border-white/20"><h4 className="text-xs font-bold text-yellow-300 uppercase mb-2">Strategy</h4><p className="text-sm font-medium">{marketReport.strategy}</p></div>}</div>
          </div>
        )}

        {/* MARKET DRILL-DOWN: EVENTS */}
        {activeTab === 'market-events' && <div className="animate-in fade-in slide-in-from-right-4 duration-300 min-h-screen pb-12"><div className="mb-6 flex items-center gap-4"><button onClick={() => setActiveTab('market')} className="p-2 bg-white rounded-full hover:bg-gray-100 border border-gray-200"><ArrowLeft size={18}/></button><h2 className="text-2xl font-bold text-gray-900">æ™ºèƒ½äº‹ä»¶é›·è¾¾ãƒ»å…¨æ™¯è§†å›¾</h2></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">{UPCOMING_EVENTS_ALL.map(event => <EventCard key={event.id} event={event} onClick={setSelectedEvent} />)}</div></div>}
        {activeTab === 'market-sectors' && <div className="animate-in fade-in slide-in-from-right-4 duration-300 min-h-screen pb-12"><div className="mb-6 flex items-center gap-4"><button onClick={() => setActiveTab('market')} className="p-2 bg-white rounded-full hover:bg-gray-100 border border-gray-200"><ArrowLeft size={18}/></button><h2 className="text-2xl font-bold text-gray-900">å…¨å¸‚åœºè¡Œä¸šæ¿å—çƒ­åŠ›</h2></div><div className="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden"><table className="w-full text-sm text-left"><thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100"><tr><th className="px-6 py-4">æ¿å—åç§°</th><th className="px-6 py-4">çƒ­åº¦</th><th className="px-6 py-4">æ¶¨è·Œå¹…</th><th className="px-6 py-4">é¢†æ¶¨è‚¡</th><th className="px-6 py-4 text-right">å‡€æµå…¥</th><th className="px-6 py-4 text-right">æ¢æ‰‹ç‡</th><th className="px-6 py-4 text-right">é‡æ¯”</th></tr></thead><tbody>{SECTORS_ALL.map((sec, i) => <tr key={i} className="hover:bg-gray-50"><td className="px-6 py-4 font-bold">{sec.name}</td><td className="px-6 py-4"><div className="w-24 h-1.5 bg-gray-100 rounded-full"><div className="h-full bg-gradient-to-r from-orange-300 to-rose-500" style={{width: `${sec.hot}%`}}></div></div></td><td className="px-6 py-4 font-bold text-rose-500">+{sec.change}%</td><td className="px-6 py-4 text-indigo-600">{sec.leadStock}</td><td className="px-6 py-4 text-right font-mono text-rose-500">{sec.netInflow}</td><td className="px-6 py-4 text-right font-mono">{sec.turnover}</td><td className="px-6 py-4 text-right font-mono">{sec.volRatio}</td></tr>)}</tbody></table></div></div>}
        {activeTab === 'stock-news' && <div className="animate-in fade-in slide-in-from-right-4 duration-300 min-h-screen pb-12"><div className="mb-6 flex items-center gap-4"><button onClick={() => setActiveTab('stock')} className="p-2 bg-white rounded-full hover:bg-gray-100 border border-gray-200"><ArrowLeft size={18}/></button><h2 className="text-2xl font-bold text-gray-900">{selectedStock.name} - ä¸ªè‚¡èˆ†æƒ…ä¸­å¿ƒ</h2></div><div className="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden p-6"><div className="flex gap-4 mb-6"><button className="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold">å…¨éƒ¨</button><button className="px-3 py-1.5 hover:bg-gray-50 text-gray-600 rounded-lg text-xs font-medium">åˆ©å¥½</button><button className="px-3 py-1.5 hover:bg-gray-50 text-gray-600 rounded-lg text-xs font-medium">åˆ©ç©º</button></div><div className="space-y-1">{STOCK_NEWS_BRIEF.map((news, i) => <NewsRow key={i} data={news} index={i} />)}</div></div></div>}
        {activeTab === 'stock-comments' && <div className="animate-in fade-in slide-in-from-right-4 duration-300 min-h-screen pb-12"><div className="mb-6 flex items-center gap-4"><button onClick={() => setActiveTab('stock')} className="p-2 bg-white rounded-full hover:bg-gray-100 border border-gray-200"><ArrowLeft size={18}/></button><h2 className="text-2xl font-bold text-gray-900">{selectedStock.name} - æ·±åº¦è¨€è®ºå¹¿åœº</h2></div><div className="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden p-6"><div className="space-y-0 divide-y divide-gray-50">{[...Array(10)].map((_, i) => <div key={i} className="p-4 hover:bg-gray-50/50 transition-colors"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">U{i}</div><div><div className="text-sm font-bold text-gray-800">è‚¡å‹_{Math.floor(Math.random()*10000)}</div><div className="text-[10px] text-gray-400">æŒä»“: {Math.random()>0.5?'5æˆ':'ç©ºä»“'}</div></div>{i < 3 && <span className="bg-amber-100 text-amber-700 text-[10px] px-1.5 rounded">å¤§V</span>}</div><span className="text-xs text-gray-400">1{i}åˆ†é’Ÿå‰</span></div><p className="text-sm text-gray-700 mb-2">ä¸»åŠ›ä»Šå¤©è¿™ä¸ªèµ°åŠ¿å®Œå…¨æ˜¯åœ¨æ´—ç›˜ï¼Œå¤§å®¶æ‹¿ä½ç­¹ç ä¸è¦åŠ¨ï¼Œæ˜å¤©è‚¯å®šååŒ…ï¼æŠ€æœ¯é¢ä¸ŠMACDå·²ç»é‡‘å‰äº†ã€‚</p><div className="flex items-center gap-4 text-xs text-gray-400"><button className="flex items-center gap-1 hover:text-indigo-600"><ThumbsUp size={14}/> {Math.floor(Math.random()*100)}</button><button className="flex items-center gap-1 hover:text-indigo-600"><MessageCircle size={14}/> {Math.floor(Math.random()*20)}</button></div></div>)}</div></div></div>}

        {/* LEADERBOARD TAB */}
        {activeTab === 'leaderboard' && <SentimentLeaderboard onStockClick={(stock) => { setSelectedStock(stock); setActiveTab('stock'); setReportData({ summary: 'ç­‰å¾…ç”Ÿæˆ...', bullCase: [], riskFactor: [], generatedAt: null }); }} />}
        {activeTab === 'graph' && (
           <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
              <div className="mb-6"><h2 className="text-2xl font-bold text-gray-900">äº§ä¸šé“¾æ³¢çº¹ä¼ å¯¼å›¾è°±</h2><p className="text-xs text-gray-500">å®æ—¶è¿½è¸ªæ ¸å¿ƒäº‹ä»¶å¯¹ä¸Šä¸‹æ¸¸æ¿å—çš„èˆ†æƒ…ä¼ å¯¼è·¯å¾„</p></div>
              <RippleGraph />
              <div className="grid grid-cols-3 gap-6 mt-6">{['ä¸Šæ¸¸ï¼šåŸææ–™', 'ä¸­æ¸¸ï¼šåˆ¶é€ å°æµ‹', 'ä¸‹æ¸¸ï¼šç»ˆç«¯åº”ç”¨'].map((t,i) => (<div key={i} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm"><h4 className="font-bold text-gray-800 text-sm mb-2">{t}</h4><div className="h-1.5 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-indigo-500" style={{width: `${80 - i * 20}%`}}></div></div><div className="text-[10px] text-gray-400 mt-1">èˆ†æƒ…æ¸—é€ç‡: {80 - i * 20}%</div></div>))}</div>
           </div>
        )}
        {activeTab === 'backtest' && <BacktestView />}

        {/* 2. STOCK VIEW (VERTICAL FLOW - v4.3 SPACIOUS) */}
        {activeTab === 'stock' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 flex flex-col gap-6 max-w-5xl mx-auto">
             
             {/* HEADER */}
             <div className="flex justify-between items-end mb-2">
                <div><h1 className="text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-4">{selectedStock.name} <span className="text-xl text-slate-400 font-mono font-light">{selectedStock.code}</span></h1><div className="flex items-center gap-6 text-sm text-slate-500 font-medium mt-2"><span>å¸‚å€¼ <span className="text-slate-900 font-semibold">{selectedStock.marketVal}</span></span><span className={`flex items-center gap-1.5 font-bold ${marketStatus.status === 'trading' ? 'text-emerald-600' : 'text-orange-500'}`}><div className={`w-1.5 h-1.5 rounded-full ${marketStatus.status === 'trading' ? 'bg-emerald-500 animate-pulse' : 'bg-orange-500'}`}></div>{marketStatus.status === 'trading' ? 'å®æ—¶è¿æ¥æ­£å¸¸' : 'è¿æ¥æŒ‚èµ· (ä¼‘å¸‚)'}</span></div></div>
                <div className="flex gap-3"><button onClick={() => setIsShareOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-white hover:bg-gray-50 rounded-lg text-gray-700 font-medium border border-gray-200 shadow-sm text-sm"><Share2 size={15}/> åˆ†äº«</button><button onClick={handleExportClick} className="flex items-center gap-2 px-4 py-2 bg-white hover:bg-gray-50 rounded-lg text-gray-700 font-medium border border-gray-200 shadow-sm text-sm"><Download size={15} /> å¯¼å‡ºç ”æŠ¥</button><button onClick={handleGenerateStockReport} disabled={isGeneratingReport} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md text-sm"><Sparkles size={15}/> AI ç®€æŠ¥</button></div>
             </div>

             {/* ROW 1: NEW DASHBOARD LAYOUT (3:6:3) */}
             <div className="grid grid-cols-12 gap-6 h-[240px]">
                {/* 1.1 Big Gauge (3 Cols) */}
                <div className="col-span-3 bg-white border border-gray-100 rounded-2xl p-6 shadow-sm flex flex-col justify-center items-center relative overflow-hidden">
                   <h4 className="absolute top-4 left-4 text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2"><Zap size={14} className="text-rose-500"/> å®æ—¶æƒ…ç»ª</h4>
                   <div className="w-full h-full flex items-center justify-center scale-90"><GaugeChart value={currentSentiment > 0 ? (currentSentiment + 1) * 50 : 50} /></div>
                </div>
                {/* 1.2 Metrics Grid (6 Cols) */}
                <div className="col-span-6 grid grid-cols-2 gap-4">
                   <EnhancedMetricCard title="å…¨ç½‘çƒ­åº¦" value="12,450" subValue="+32/min" trend="up" icon={Flame} colorClass="text-orange-500" bgClass="bg-orange-50" type="heat" />
                   <EnhancedMetricCard title="å¤šç©ºåˆ†æ­§" value="High" subValue="æ•£æˆ·çœ‹å¤š" trend="down" icon={Layers} colorClass="text-indigo-500" bgClass="bg-indigo-50" type="divergence" />
                </div>
                {/* 1.3 AI Prediction (3 Cols) */}
                <div className="col-span-3 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white flex flex-col justify-between shadow-lg shadow-emerald-200 relative overflow-hidden">
                   <div className="absolute top-0 right-0 p-16 bg-white/10 rounded-full blur-2xl -mr-8 -mt-8 pointer-events-none"></div>
                   <div className="relative z-10">
                      <h4 className="text-xs font-bold text-emerald-100 uppercase tracking-wider mb-2">AI Alpha é¢„æµ‹</h4>
                      <div className="text-4xl font-bold font-mono tracking-tight">+1.2%</div>
                      <div className="text-xs text-emerald-100 mt-1 opacity-80">æœªæ¥ 4 å°æ—¶é¢„æœŸ</div>
                   </div>
                   <div className="relative z-10 bg-white/20 backdrop-blur-md rounded-lg p-3 text-xs font-medium leading-relaxed border border-white/10">
                      <Sparkles size={12} className="inline mr-1"/> çŸ­æœŸæƒ…ç»ªå…±æŒ¯ï¼Œä¸Šæ¶¨æ¦‚ç‡ 72%
                   </div>
                </div>
             </div>
             
             {/* ROW 2: MAIN CHART (Full Width) */}
             <div className="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm h-[500px] flex flex-col w-full">
                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2"><BarChart2 size={18} className="text-slate-500"/> ä»·æ ¼ä¸èˆ†æƒ…åŒæ­¥è§†çª—</h3></div>
                <div className="flex-1 min-h-0 mb-2"><ResponsiveContainer width="100%" height="100%"><AreaChart data={chartData} syncId="stockSync"><defs><linearGradient id="colorPrice" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.1}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><XAxis dataKey="time" hide /><YAxis domain={['auto', 'auto']} orientation="right" tick={{fontSize:11}} stroke="#94a3b8" /><Tooltip contentStyle={{backgroundColor:'#fff', borderRadius:'8px', boxShadow:'0 4px 6px -1px rgba(0,0,0,0.1)'}} /><Area type="monotone" dataKey="price" stroke="#6366f1" strokeWidth={2} fill="url(#colorPrice)" name="è‚¡ä»·" /></AreaChart></ResponsiveContainer></div>
                <div className="h-1/3 min-h-0 border-t border-gray-100 pt-2"><ResponsiveContainer width="100%" height="100%"><BarChart data={chartData} syncId="stockSync"><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><XAxis dataKey="time" tick={{fontSize:11}} stroke="#94a3b8" /><YAxis domain={[-1.5, 1.5]} orientation="right" tick={{fontSize:11}} stroke="#94a3b8" /><Tooltip /><ReferenceLine y={0} stroke="#cbd5e1" /><Bar dataKey="sentiment" name="èˆ†æƒ…å‡€å€¼">{chartData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.sentiment > 0 ? '#f43f5e' : '#10b981'} />)}</Bar></BarChart></ResponsiveContainer></div>
             </div>

             {/* ROW 3: SMART MONEY (Full Width) */}
             <div className="w-full"><SmartMoneyChart data={chartData} /></div>

             {/* ROW 4: PK (Full Width) */}
             <div className="w-full"><SentimentPK /></div>

             {/* ROW 5: NEWS (Full Width) */}
             <div className="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm flex flex-col w-full">
                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Flame className="text-orange-500" size={18}/> å®æ—¶æ–°é—»çƒ­ç‚¹</h3><button onClick={() => setActiveTab('stock-news')} className="flex items-center gap-1 text-xs text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded transition-colors">æŸ¥çœ‹æ›´å¤š <ChevronRight size={12} /></button></div>
                <div className="space-y-0">{STOCK_NEWS_BRIEF.map((n,i) => <NewsRow key={i} data={n} index={i} />)}</div>
             </div>

             {/* ROW 6: COMMENTS (Full Width) */}
             <div className="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm flex flex-col w-full">
                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2"><MessageSquare className="text-indigo-500" size={18}/> ç¤¾åŒºè®¨è®ºæµ</h3><button onClick={() => setActiveTab('stock-comments')} className="flex items-center gap-1 text-xs text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded transition-colors">æŸ¥çœ‹æ›´å¤š <ChevronRight size={12} /></button></div>
                <div className="flex-1 overflow-y-auto custom-scrollbar -mx-2 px-2 max-h-[500px]">{comments.map(c => <CommentRow key={c.id} {...c} onAnalyze={handleAnalyzeComment} />)}</div>
             </div>

             {/* FOOTER: AI REPORT */}
             <div className="bg-gradient-to-r from-slate-50 to-white border border-slate-200 rounded-2xl p-8 shadow-sm mb-8">
                 <div className="flex gap-8">
                    <div className="w-1/3 border-r border-slate-200 pr-8">
                       <h4 className="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider flex items-center gap-2"><FileText size={14}/> æ ¸å¿ƒå…³é”®è¯äº‘</h4>
                       <div className="flex flex-wrap gap-2">{KEYWORDS.map((k, i) => <span key={i} className={`px-2 py-1 rounded text-xs font-medium border ${k.type==='pos'?'bg-rose-50 border-rose-100 text-rose-700':k.type==='neg'?'bg-emerald-50 border-emerald-100 text-emerald-700':'bg-gray-50 border-gray-200 text-gray-600'}`}>{k.text}</span>)}</div>
                    </div>
                    <div className="flex-1">
                       <h4 className="text-sm font-bold text-indigo-800 uppercase mb-4 flex items-center gap-2"><Zap size={16} className="fill-indigo-600"/> Gemini æ·±åº¦ç ”æŠ¥</h4>
                       <p className="text-slate-700 text-sm leading-relaxed mb-4">{reportData.summary}</p>
                       {reportData.bullCase.length > 0 && <div className="grid grid-cols-2 gap-4"><div className="bg-white p-3 rounded border border-rose-100"><h5 className="text-rose-600 font-bold text-xs mb-2">çœ‹å¤šé€»è¾‘</h5><ul className="list-disc list-inside text-xs text-gray-500">{reportData.bullCase.map(s=><li key={s}>{s}</li>)}</ul></div><div className="bg-white p-3 rounded border border-emerald-100"><h5 className="text-emerald-600 font-bold text-xs mb-2">é£é™©æç¤º</h5><ul className="list-disc list-inside text-xs text-gray-500">{reportData.riskFactor.map(s=><li key={s}>{s}</li>)}</ul></div></div>}
                    </div>
                 </div>
             </div>
          </div>
        )}

      </main>
    </div>
  );
}